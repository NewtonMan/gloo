### What you'll need

- [`kubectl`](https://kubernetes.io/docs/tasks/tools/install-kubectl/)
- Kubernetes v1.8+ deployed somewhere. [Minikube](https://kubernetes.io/docs/tasks/tools/install-minikube/) is a great way to get a cluster up quickly.

### Steps

1. Gloo and Envoy [installed](../../installation/kubernetes.md) and running on Kubernetes.

1. Next, deploy the Pet Store app to Kubernetes:

    ```bash
    kubectl apply \
      -f https://raw.githubusercontent.com/solo-io/gloo/master/example/petstore/petstore.yaml
    ```

1. The discovery services should have already created an *Upstream* for the petstore service.

    Let's verify this:

    ```bash
    glooctl get upstreams
    ```

    ```bash
    +-----------------------------------------------------------------+------------+----------+---------------------------------------+
    |                            UPSTREAM                             |    TYPE    |  STATUS  |                DETAILS                |
    +-----------------------------------------------------------------+------------+----------+---------------------------------------+
    | default-kubernetes-443                                          | Kubernetes | Accepted | svc name:      kubernetes             |
    |                                                                 |            |          | svc namespace: default                |
    |                                                                 |            |          | port:          443                    |
    |                                                                 |            |          |                                       |
    | default-petstore-8080                                           | Kubernetes | Accepted | svc name:      petstore               |
    |                                                                 |            |          | svc namespace: default                |
    |                                                                 |            |          | port:          8080                   |
    |                                                                 |            |          | REST service:                         |
    |                                                                 |            |          | functions:                            |
    |                                                                 |            |          | - addPet                              |
    |                                                                 |            |          | - deletePet                           |
    |                                                                 |            |          | - findPetById                         |
    |                                                                 |            |          | - findPets                            |
    |                                                                 |            |          |                                       |
    | extauth                                                         | Kubernetes | Accepted | svc name:      extauth                |
    |                                                                 |            |          | svc namespace: gloo-system            |
    |                                                                 |            |          | port:          8080                   |
    |                                                                 |            |          | gRPC service:                         |
    |                                                                 |            |          |                                       |
    | gloo-system-apiserver-ui-8088                                   | Kubernetes | Accepted | svc name:      apiserver-ui           |
    |                                                                 |            |          | svc namespace: gloo-system            |
    |                                                                 |            |          | port:          8088                   |
    |                                                                 |            |          |                                       |
    | gloo-system-extauth-8080                                        | Kubernetes | Accepted | svc name:      extauth                |
    |                                                                 |            |          | svc namespace: gloo-system            |
    |                                                                 |            |          | port:          8080                   |
    |                                                                 |            |          | gRPC service:                         |
    |                                                                 |            |          |                                       |
    | gloo-system-gateway-proxy-8080                                  | Kubernetes | Accepted | svc name:      gateway-proxy          |
    |                                                                 |            |          | svc namespace: gloo-system            |
    |                                                                 |            |          | port:          8080                   |
    |                                                                 |            |          |                                       |
    | gloo-system-gloo-9977                                           | Kubernetes | Accepted | svc name:      gloo                   |
    |                                                                 |            |          | svc namespace: gloo-system            |
    |                                                                 |            |          | port:          9977                   |
    |                                                                 |            |          |                                       |
    | gloo-system-gloo-ee-grafana-80                                  | Kubernetes | Accepted | svc name:      gloo-ee-grafana        |
    |                                                                 |            |          | svc namespace: gloo-system            |
    |                                                                 |            |          | port:          80                     |
    |                                                                 |            |          |                                       |
    | gloo-system-gloo-ee-prometheus-kube-state-metrics-80            | Kubernetes | Accepted | svc name:                             |
    |                                                                 |            |          | gloo-ee-prometheus-kube-state-metrics |
    |                                                                 |            |          | svc namespace: gloo-system            |
    |                                                                 |            |          | port:          80                     |
    |                                                                 |            |          |                                       |
    | gloo-system-gloo-ee-prometheus-kube-state-metrics-80-77c4e7f971 | Kubernetes | Accepted | svc name:                             |
    |                                                                 |            |          | gloo-ee-prometheus-kube-state-metrics |
    |                                                                 |            |          | svc namespace: gloo-system            |
    |                                                                 |            |          | port:          80                     |
    |                                                                 |            |          |                                       |
    | gloo-system-gloo-ee-prometheus-server-80                        | Kubernetes | Accepted | svc name:                             |
    |                                                                 |            |          | gloo-ee-prometheus-server             |
    |                                                                 |            |          | svc namespace: gloo-system            |
    |                                                                 |            |          | port:          80                     |
    |                                                                 |            |          |                                       |
    | gloo-system-gloo-ee-prometheus-server-80-143a7368f0cceaec875362 | Kubernetes | Accepted | svc name:                             |
    |                                                                 |            |          | gloo-ee-prometheus-server             |
    |                                                                 |            |          | svc namespace: gloo-system            |
    |                                                                 |            |          | port:          80                     |
    |                                                                 |            |          |                                       |
    | gloo-system-rate-limit-18081                                    | Kubernetes | Accepted | svc name:      rate-limit             |
    |                                                                 |            |          | svc namespace: gloo-system            |
    |                                                                 |            |          | port:          18081                  |
    |                                                                 |            |          |                                       |
    | gloo-system-redis-6379                                          | Kubernetes | Accepted | svc name:      redis                  |
    |                                                                 |            |          | svc namespace: gloo-system            |
    |                                                                 |            |          | port:          6379                   |
    |                                                                 |            |          |                                       |
    | kube-system-kube-dns-53                                         | Kubernetes | Accepted | svc name:      kube-dns               |
    |                                                                 |            |          | svc namespace: kube-system            |
    |                                                                 |            |          | port:          53                     |
    |                                                                 |            |          |                                       |
    | rate-limit                                                      | Kubernetes | Accepted | svc name:      rate-limit             |
    |                                                                 |            |          | svc namespace: gloo-system            |
    |                                                                 |            |          | port:          18081                  |
    |                                                                 |            |          |                                       |
    +-----------------------------------------------------------------+------------+----------+---------------------------------------+
    ```

    The upstream we want to see is `default-petstore-8080`. Digging a little deeper, we can verify that Gloo's function
    discovery populated our upstream with the available rest endpoints it implements.
    Note: the upstream was created in the `gloo-system` namespace rather than `default` because it was created by a
    discovery service. Upstreams and virtual Services do not need to live in the `gloo-system` namespace to be processed
    by Gloo.

1. Let's take a closer look at the functions that are available on this upstream (edited here to reduce verbosity):

    ```yaml
    ---
    discoveryMetadata: {}
    upstreamSpec:
      kube:
        selector:
          app: petstore
        serviceName: petstore
        serviceNamespace: default
        servicePort: 8080
        serviceSpec:
          rest:
            swaggerInfo:
              url: http://petstore.default.svc.cluster.local:8080/swagger.json
            transformations:
              addPet:
                body:
                  text: '{"id": {{ default(id, "") }},"name": "{{ default(name, "")}}","tag":
                    "{{ default(tag, "")}}"}'
                headers:
                  :method:
                    text: POST
                  :path:
                    text: /api/pets
                  content-type:
                    text: application/json
              deletePet:
                headers:
                  :method:
                    text: DELETE
                  :path:
                    text: /api/pets/{{ default(id, "") }}
                  content-type:
                    text: application/json
              findPetById:
                body: {}
                headers:
                  :method:
                    text: GET
                  :path:
                    text: /api/pets/{{ default(id, "") }}
                  content-length:
                    text: "0"
                  content-type: {}
                  transfer-encoding: {}
              findPets:
                body: {}
                headers:
                  :method:
                    text: GET
                  :path:
                    text: /api/pets?tags={{default(tags, "")}}&limit={{default(limit,
                      "")}}
                  content-length:
                    text: "0"
                  content-type: {}
                  transfer-encoding: {}
    ```

    The details of this application were discovered by Gloo's Function Discovery (fds) service. Because the petstore
    application implements OpenAPI (specifically discovering a Swagger JSON document on `petstore-svc/swagger.json`).
    Because some functions were discovered for us, we can practice some function in the next tutorial.

1. Let's now use `glooctl` to create a basic route for this *Upstream*.

    ```bash
    glooctl add route \
      --path-exact /sample-route-1 \
      --dest-name default-petstore-8080 \
      --prefix-rewrite /api/pets
    ```

    We use the `--prefix-rewrite` to rewrite path on incoming requests to match the paths our petstore expects.

    Note that we have omitted the `--name` flag for selecting a virtual service. Routes are always assoicated with a
    virtual service in Gloo, which groups routes by their domain. Since we skipped creating a virtual service for this
    route, `my-virtual-service` will be created automatically for us.

    With `glooctl`, we can see that a virtual service was created with our route:

    ```bash
    glooctl get virtualservice -o yaml
    ```

    ```yaml
    ---
    metadata:
      name: default
      namespace: gloo-system
      resourceVersion: "4592"
    status:
      reportedBy: gateway
      state: Accepted
      subresourceStatuses:
        '*v1.Proxy gloo-system gateway-proxy':
          reportedBy: gloo
          state: Accepted
    virtualHost:
      domains:
      - '*'
      name: gloo-system.default
      routes:
      - matcher:
          exact: /sample-route-1
        routeAction:
          single:
            upstream:
              name: default-petstore-8080
              namespace: gloo-system
        routePlugins:
          prefixRewrite:
            prefixRewrite: /api/pets
    ```

    Note that you can add routes interactively using `glooctl add route -i`. This is a great way to explore Gloo's
    configuration options from the CLI.

1. Let's test the route `/sample-route-1` using `curl`:

    ```bash
    export PROXY_URL=$(glooctl proxy url)
    curl ${PROXY_URL}/sample-route-1
    ```

    ```json
    [{"id":1,"name":"Dog","status":"available"},{"id":2,"name":"Cat","status":"pending"}]
    ```

Great! Our proxy is up and running. Let's make things a bit more sophisticated in the next section with [Function Routing](2.md).
