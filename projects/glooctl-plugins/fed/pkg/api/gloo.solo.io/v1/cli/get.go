// Code generated by skv2. DO NOT EDIT.

package gloo_cli_client

import (
	"context"
	"flag"
	"fmt"
	"os"
	"time"

	"github.com/olekukonko/tablewriter"
	"github.com/solo-io/gloo/pkg/cliutil"
	"github.com/solo-io/skv2/pkg/ezkube"
	rpc_edge_v1 "github.com/solo-io/solo-projects/projects/apiserver/pkg/api/rpc.edge.gloo/v1"
	"github.com/solo-io/solo-projects/projects/glooctl-plugins/fed/pkg/cmd/options"
	"github.com/solo-io/solo-projects/projects/glooctl-plugins/fed/pkg/constants"
	"github.com/spf13/cobra"
	"google.golang.org/grpc"
)

func Upstream(opts *options.Options) *cobra.Command {
	cmd := &cobra.Command{
		Use:     constants.UPSTREAM_COMMAND.Use,
		Aliases: constants.UPSTREAM_COMMAND.Aliases,
		Short:   "list Upstreams across all clusters",
		Long:    "usage: glooctl fed get upstream [NAME] [--namespace=namespace] [-o FORMAT]",
		RunE: func(cmd *cobra.Command, args []string) error {
			flag.Parse()
			portFwd, err := cliutil.PortForward(opts.Namespace, "deploy/gloo-fed-console", opts.ApiserverPort, opts.ApiserverPort, false)
			if err != nil {
				return err
			}
			defer func() {
				if portFwd.Process != nil {
					portFwd.Process.Kill()
					portFwd.Process.Release()
				}
			}()
			grpcOpts := []grpc.DialOption{
				grpc.WithInsecure(),
				grpc.WithBlock(),
			}
			serverAddr := "localhost:" + opts.ApiserverPort
			ctx, _ := context.WithTimeout(opts.Ctx, 10*time.Second)
			conn, err := grpc.DialContext(ctx, serverAddr, grpcOpts...)
			if err != nil {
				return err
			}
			defer conn.Close()
			client := rpc_edge_v1.NewGlooResourceApiClient(conn)
			upstreams, err := client.ListUpstreams(opts.Ctx, &rpc_edge_v1.ListUpstreamsRequest{})
			if err != nil {
				return err
			}

			table := tablewriter.NewWriter(os.Stdout)
			table.SetHeader([]string{"CLUSTER", "NAMESPACE", "NAME"})
			for _, v := range upstreams.GetUpstreams() {
				table.Append([]string{ezkube.GetClusterName(v.GetMetadata()), v.GetMetadata().GetNamespace(), v.GetMetadata().GetName()})
			}
			if table.NumLines() == 0 {
				fmt.Printf("No resources found.\n")
			} else {
				table.Render()
			}
			return nil
		},
	}
	return cmd
}

func UpstreamGroup(opts *options.Options) *cobra.Command {
	cmd := &cobra.Command{
		Use:     constants.UPSTREAM_GROUP_COMMAND.Use,
		Aliases: constants.UPSTREAM_GROUP_COMMAND.Aliases,
		Short:   "list UpstreamGroups across all clusters",
		Long:    "usage: glooctl fed get upstreamgroup [NAME] [--namespace=namespace] [-o FORMAT]",
		RunE: func(cmd *cobra.Command, args []string) error {
			flag.Parse()
			portFwd, err := cliutil.PortForward(opts.Namespace, "deploy/gloo-fed-console", opts.ApiserverPort, opts.ApiserverPort, false)
			if err != nil {
				return err
			}
			defer func() {
				if portFwd.Process != nil {
					portFwd.Process.Kill()
					portFwd.Process.Release()
				}
			}()
			grpcOpts := []grpc.DialOption{
				grpc.WithInsecure(),
				grpc.WithBlock(),
			}
			serverAddr := "localhost:" + opts.ApiserverPort
			ctx, _ := context.WithTimeout(opts.Ctx, 10*time.Second)
			conn, err := grpc.DialContext(ctx, serverAddr, grpcOpts...)
			if err != nil {
				return err
			}
			defer conn.Close()
			client := rpc_edge_v1.NewGlooResourceApiClient(conn)
			upstreamGroups, err := client.ListUpstreamGroups(opts.Ctx, &rpc_edge_v1.ListUpstreamGroupsRequest{})
			if err != nil {
				return err
			}

			table := tablewriter.NewWriter(os.Stdout)
			table.SetHeader([]string{"CLUSTER", "NAMESPACE", "NAME"})
			for _, v := range upstreamGroups.GetUpstreamGroups() {
				table.Append([]string{ezkube.GetClusterName(v.GetMetadata()), v.GetMetadata().GetNamespace(), v.GetMetadata().GetName()})
			}
			if table.NumLines() == 0 {
				fmt.Printf("No resources found.\n")
			} else {
				table.Render()
			}
			return nil
		},
	}
	return cmd
}

func Settings(opts *options.Options) *cobra.Command {
	cmd := &cobra.Command{
		Use:     constants.SETTINGS_COMMAND.Use,
		Aliases: constants.SETTINGS_COMMAND.Aliases,
		Short:   "list Settings across all clusters",
		Long:    "usage: glooctl fed get settings [NAME] [--namespace=namespace] [-o FORMAT]",
		RunE: func(cmd *cobra.Command, args []string) error {
			flag.Parse()
			portFwd, err := cliutil.PortForward(opts.Namespace, "deploy/gloo-fed-console", opts.ApiserverPort, opts.ApiserverPort, false)
			if err != nil {
				return err
			}
			defer func() {
				if portFwd.Process != nil {
					portFwd.Process.Kill()
					portFwd.Process.Release()
				}
			}()
			grpcOpts := []grpc.DialOption{
				grpc.WithInsecure(),
				grpc.WithBlock(),
			}
			serverAddr := "localhost:" + opts.ApiserverPort
			ctx, _ := context.WithTimeout(opts.Ctx, 10*time.Second)
			conn, err := grpc.DialContext(ctx, serverAddr, grpcOpts...)
			if err != nil {
				return err
			}
			defer conn.Close()
			client := rpc_edge_v1.NewGlooResourceApiClient(conn)
			settings, err := client.ListSettings(opts.Ctx, &rpc_edge_v1.ListSettingsRequest{})
			if err != nil {
				return err
			}

			table := tablewriter.NewWriter(os.Stdout)
			table.SetHeader([]string{"CLUSTER", "NAMESPACE", "NAME"})
			for _, v := range settings.GetSettings() {
				table.Append([]string{ezkube.GetClusterName(v.GetMetadata()), v.GetMetadata().GetNamespace(), v.GetMetadata().GetName()})
			}
			if table.NumLines() == 0 {
				fmt.Printf("No resources found.\n")
			} else {
				table.Render()
			}
			return nil
		},
	}
	return cmd
}

func Proxy(opts *options.Options) *cobra.Command {
	cmd := &cobra.Command{
		Use:     constants.PROXY_COMMAND.Use,
		Aliases: constants.PROXY_COMMAND.Aliases,
		Short:   "list Proxies across all clusters",
		Long:    "usage: glooctl fed get proxy [NAME] [--namespace=namespace] [-o FORMAT]",
		RunE: func(cmd *cobra.Command, args []string) error {
			flag.Parse()
			portFwd, err := cliutil.PortForward(opts.Namespace, "deploy/gloo-fed-console", opts.ApiserverPort, opts.ApiserverPort, false)
			if err != nil {
				return err
			}
			defer func() {
				if portFwd.Process != nil {
					portFwd.Process.Kill()
					portFwd.Process.Release()
				}
			}()
			grpcOpts := []grpc.DialOption{
				grpc.WithInsecure(),
				grpc.WithBlock(),
			}
			serverAddr := "localhost:" + opts.ApiserverPort
			ctx, _ := context.WithTimeout(opts.Ctx, 10*time.Second)
			conn, err := grpc.DialContext(ctx, serverAddr, grpcOpts...)
			if err != nil {
				return err
			}
			defer conn.Close()
			client := rpc_edge_v1.NewGlooResourceApiClient(conn)
			proxies, err := client.ListProxies(opts.Ctx, &rpc_edge_v1.ListProxiesRequest{})
			if err != nil {
				return err
			}

			table := tablewriter.NewWriter(os.Stdout)
			table.SetHeader([]string{"CLUSTER", "NAMESPACE", "NAME"})
			for _, v := range proxies.GetProxies() {
				table.Append([]string{ezkube.GetClusterName(v.GetMetadata()), v.GetMetadata().GetNamespace(), v.GetMetadata().GetName()})
			}
			if table.NumLines() == 0 {
				fmt.Printf("No resources found.\n")
			} else {
				table.Render()
			}
			return nil
		},
	}
	return cmd
}
